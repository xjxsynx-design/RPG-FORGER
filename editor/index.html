<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RPG DREAM EDITOR</title>
<style>
:root{
 --bg:#0b0718;--panel:#16102a;--stroke:#3a2b7a;--primary:#7b5cff;
 --text:#efeaff;--white:#ffffff;--grid:#3a2b7a
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
 font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
#topbar{display:flex;align-items:center;gap:8px;padding:10px;
 background:var(--panel);border-bottom:1px solid var(--stroke)}
#topbar .spacer{flex:1}
button{background:var(--primary);border:none;border-radius:12px;
 color:#fff;padding:8px 12px;font-size:13px;white-space:nowrap}
button.secondary{background:transparent;border:1px solid var(--primary)}
button.active{outline:2px solid #fff}

#toolbar{
 display:flex;gap:8px;padding:8px;background:#120b22;
 border-bottom:1px solid var(--stroke);
 overflow-x:auto;white-space:nowrap
}
#toolbar button{flex-shrink:0}

canvas{display:block;touch-action:none}

#phaseLabel{
 position:fixed;left:50%;bottom:6px;transform:translateX(-50%);
 color:#7bffcc;font-weight:700;letter-spacing:.08em;
 text-shadow:0 0 6px rgba(123,255,204,.6)
}

/* mandatory view selection modal */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
.modal{width:100%;max-width:360px;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px}
.modal h3{margin:0 0 12px 0;font-size:16px}
.modal .row{display:flex;gap:10px}
.modal button{flex:1;border:none;border-radius:12px;padding:12px;background:var(--primary);color:var(--white);font-weight:600}
.modal button.secondary{background:transparent;border:1px solid var(--stroke);color:var(--text)}
</style>
</head>
<body>

<div id="topbar">
 <strong>Editor</strong>
 <div class="spacer"></div>
 <button id="saveBtn">Save</button>
</div>

<div id="toolbar">
 <button class="active">Paint</button>
 <button class="secondary">Erase</button>
 <button class="secondary">Pan</button>
 <button class="secondary">Region</button>
 <button class="secondary">Object</button>
 <button class="secondary">Music</button>
</div>

<canvas id="canvas"></canvas>
<div id="phaseLabel">PHASE 14F.1a</div>

<script>
const active = JSON.parse(localStorage.getItem("rpgdream_active_project")||"null");
if(!active){ location.href="../manager/index.html"; }

// âœ… Map-level viewMode (supports different view per map)
const maps = active.data?.maps || active.maps || [];
const activeMapId =
  active.data?.editor?.activeMapId ||
  active.editor?.activeMapId ||
  (maps[0] && maps[0].id);

const map = maps.find(m => m.id === activeMapId) || maps[0] || null;

// If no map exists, fail loudly (manager should always create at least one map)
if(!map){
  alert("No maps found in active project. Please create a new project in Manager.");
  location.href="../manager/index.html";
}

let view = (map && (map.viewMode === "angular" || map.viewMode === "top")) ? map.viewMode : null;

let __renderStarted = false;
function __startRenderOnce(){
  if(__renderStarted) return;
  __renderStarted = true;
  render();
}

// Persist active project + project list safely
function __persistActiveProject(activeProject){
  try{
    localStorage.setItem("rpgdream_active_project", JSON.stringify(activeProject));
    const projects = JSON.parse(localStorage.getItem("rpgdream_projects") || "[]");
    const idx = projects.findIndex(p => p.id === activeProject.id);
    if(idx >= 0){
      projects[idx] = activeProject;
      localStorage.setItem("rpgdream_projects", JSON.stringify(projects));
    }
  }catch(e){
    console.warn("Persist failed", e);
  }
}

function __requireViewModeSelection(){
  const modal = document.getElementById("viewModal");
  const btnTop = document.getElementById("btnViewTop");
  const btnAng = document.getElementById("btnViewAngular");
  const btnCancel = document.getElementById("btnViewCancel");
  if(!modal || !btnTop || !btnAng || !btnCancel){
    alert("View selection UI missing. Please reload.");
    return;
  }
  modal.classList.remove("hidden");

  const choose = (mode) => {
    // Map-level viewMode (supports mixed-view projects)
    map.viewMode = mode;
    view = mode;
    // Write back to whichever container exists
    if(active.data?.maps){
      const mi = active.data.maps.findIndex(m => m.id === map.id);
      if(mi >= 0) active.data.maps[mi] = map;
    }else if(active.maps){
      const mi = active.maps.findIndex(m => m.id === map.id);
      if(mi >= 0) active.maps[mi] = map;
    }
    __persistActiveProject(active);
    modal.classList.add("hidden");
    __startRenderOnce();
  };

  btnTop.onclick = () => choose("top");
  btnAng.onclick = () => choose("angular");
  btnCancel.onclick = () => { location.href = "../manager/index.html"; };
}



const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const TILE = parseInt(map.tileSize || active.tile || 32, 10);
let cam = { x:0, y:0, zoom:1 };

function resize(){
 canvas.width = innerWidth;
 canvas.height = innerHeight - 120;
}
window.addEventListener("resize", resize);
resize();

function isoToScreen(x,y){
 return {
  x: (x - y) * (TILE/2),
  y: (x + y) * (TILE/4)
 };
}

function drawTopGrid(){
 const step = TILE * cam.zoom;
 ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid');
 for(let x=0;x<canvas.width;x+=step){
  ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
 }
 for(let y=0;y<canvas.height;y+=step){
  ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
 }
}

function drawAngularGrid(){
 ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid');
 const range = 40;
 for(let x=-range;x<=range;x++){
  for(let y=-range;y<=range;y++){
   const p = isoToScreen(x,y);
   ctx.beginPath();
   ctx.moveTo(p.x, p.y - TILE/4);
   ctx.lineTo(p.x + TILE/2, p.y);
   ctx.lineTo(p.x, p.y + TILE/4);
   ctx.lineTo(p.x - TILE/2, p.y);
   ctx.closePath();
   ctx.stroke();
  }
 }
}

function render(){
 ctx.setTransform(1,0,0,1,0,0);
 ctx.clearRect(0,0,canvas.width,canvas.height);

 ctx.translate(canvas.width/2, canvas.height/2);
 ctx.scale(cam.zoom, cam.zoom);
 ctx.translate(-canvas.width/2 - cam.x, -canvas.height/2 - cam.y);

 if(view === "angular") drawAngularGrid();
 else drawTopGrid();

 requestAnimationFrame(render);
}
if(view){ __startRenderOnce(); }
else { __requireViewModeSelection(); }

canvas.addEventListener("wheel", e=>{
 e.preventDefault();
 cam.zoom = Math.max(.5, Math.min(3, cam.zoom + (e.deltaY>0?-0.1:0.1)));
},{passive:false});

let panning=false, last={x:0,y:0};
canvas.addEventListener("pointerdown", e=>{
 panning=true; last={x:e.clientX,y:e.clientY};
});
canvas.addEventListener("pointermove", e=>{
 if(panning){
  cam.x += (last.x - e.clientX)/cam.zoom;
  cam.y += (last.y - e.clientY)/cam.zoom;
  last={x:e.clientX,y:e.clientY};
 }
});
canvas.addEventListener("pointerup", ()=>panning=false);
canvas.addEventListener("pointerleave", ()=>panning=false);
</script>

<!-- VIEW MODE REQUIRED MODAL -->
<div id="viewModal" class="backdrop hidden">
  <div class="modal">
    <h3>Select map view mode</h3>
    <p style="margin:0 0 14px 0; color: var(--text); opacity:.9; font-size:13px;">
      This is required before the editor starts. You can change it per-map later.
    </p>
    <div class="row">
      <button id="btnViewTop" type="button">Top Down</button>
      <button id="btnViewAngular" type="button">Angular</button>
    </div>
    <div style="height:12px"></div>
    <button id="btnViewCancel" class="secondary" type="button">Back to Manager</button>
  </div>
</div>

</body>
</html>
